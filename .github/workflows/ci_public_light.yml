# +-------------------------------------------------------------+
# |                          CERTEUS                            |
# +-------------------------------------------------------------+
# | FILE: .github/workflows/ci_public_light.yml                 |
# | ROLE: Lightweight CI for public mirror                      |
# +-------------------------------------------------------------+

name: CI-Public-Light

on:
  push:
  pull_request:

jobs:
  ci-public-light:
    name: ci-public-light
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Link-check (local md links)
        run: |
          python - << 'PY'
          import os, re, sys, pathlib
          root = pathlib.Path('docs')
          link_re = re.compile(r'\[[^\]]+\]\(([^)#]+)\)')
          missing = []
          for md in root.rglob('*.md'):
              txt = md.read_text(encoding='utf-8', errors='ignore')
              base = md.parent
              for href in link_re.findall(txt):
                  if href.startswith(('http://','https://','#','/','data:')):
                      continue
                  target = (base / href).resolve()
                  if not target.exists():
                      missing.append(f"{md}:{href}")
          if missing:
              print('Missing local links:', *missing, sep='\n', file=sys.stderr)
              sys.exit(1)
          print('OK: local links resolve')
          PY
      - name: Spectral (OpenAPI public)
        run: |
          if [ -f docs/api/openapi.public.yaml ]; then \
            npx -y @stoplight/spectral-cli lint docs/api/openapi.public.yaml; \
          else \
            echo "No public OpenAPI present; skipping Spectral"; \
          fi
      - name: Build docs (no deploy)
        run: |
          python -m pip install -U pip wheel setuptools
          python -m pip install mkdocs mkdocs-material
          mkdocs build -d _site

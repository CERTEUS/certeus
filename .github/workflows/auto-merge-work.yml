# +-------------------------------------------------------------+
# |                          CERTEUS                            |
# +-------------------------------------------------------------+
# | FILE: .github/workflows/auto-merge-work.yml               |
# | ROLE: Auto-merge from work branches to main                |
# +-------------------------------------------------------------+

name: auto-merge-work

on:
  push:
    branches: [work/daily, work/daily-new]
  workflow_dispatch:
    inputs:
      source_branch:
        description: "Source branch to merge from"
        required: true
        default: "work/daily"
      target_branch:
        description: "Target branch to merge to"
        required: true
        default: "main"

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-merge:
    name: Auto-merge work branch
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "certeus-merge-bot[bot]"
          git config user.email "certeus-merge-bot[bot]@users.noreply.github.com"

      - name: Determine branches
        id: branches
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "source=${{ github.event.inputs.source_branch }}" >> $GITHUB_OUTPUT
            echo "target=${{ github.event.inputs.target_branch }}" >> $GITHUB_OUTPUT
          else
            echo "source=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
            echo "target=main" >> $GITHUB_OUTPUT
          fi

      - name: Direct merge to main
        continue-on-error: true
        run: |
          SOURCE="${{ steps.branches.outputs.source }}"
          TARGET="${{ steps.branches.outputs.target }}"

          echo "Attempting direct merge from $SOURCE to $TARGET"

          # Fetch all branches
          git fetch --all

          # Switch to target branch
          git checkout $TARGET
          git pull origin $TARGET

          # Get latest source
          git checkout $SOURCE  
          git pull origin $SOURCE

          # Back to target and merge
          git checkout $TARGET

          echo "Attempting rebase strategy merge..."
          if git rebase origin/$SOURCE; then
            echo "✅ Rebase successful"
            git push origin $TARGET --force-with-lease
            echo "✅ Force pushed rebased $TARGET"
          else
            echo "⚠️ Rebase failed, trying merge strategy..."
            git rebase --abort 2>/dev/null || true
            
            if git merge origin/$SOURCE --no-ff -m "auto: Merge $SOURCE into $TARGET [auto-merge]"; then
              echo "✅ Merge successful"
              git push origin $TARGET
              echo "✅ Pushed merged $TARGET"
            else
              echo "❌ Both rebase and merge failed"
              echo "Manual intervention required"
              git merge --abort 2>/dev/null || true
              exit 1
            fi
          fi

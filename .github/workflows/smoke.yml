# +-------------------------------------------------------------+
# |                          CERTEUS                            |
# +-------------------------------------------------------------+
# | FILE: .github/workflows/smoke.yml                         |
# | ROLE: Project YAML manifest.                                |
# | PLIK: .github/workflows/smoke.yml                         |
# | ROLA: Manifest YAML projektu.                               |
# +-------------------------------------------------------------+

name: Smoke

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke:
    name: Smoke (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          python -m pip install -U pip wheel setuptools
          python -m pip install ruff pytest jsonschema cryptography fastapi uvicorn prometheus-client openapi-spec-validator python-multipart z3-solver -c constraints/requirements-constraints.txt || python -m pip install -U prometheus-client openapi-spec-validator python-multipart z3-solver
      - name: Install deps (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          py -3 -m pip install -U pip wheel setuptools
          py -3 -m pip install ruff pytest jsonschema cryptography fastapi uvicorn prometheus-client openapi-spec-validator python-multipart z3-solver -c constraints/requirements-constraints.txt; if ($LASTEXITCODE -ne 0) { py -3 -m pip install -U prometheus-client openapi-spec-validator python-multipart z3-solver }
      - name: Run smoke (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        continue-on-error: true
        run: bash ./scripts/smoke_api.sh
      - name: Run smoke (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        continue-on-error: true
        run: pwsh -File .\scripts\smoke_api.ps1

      - name: ?? Append Spectral summary to job summary
        if: always()
        uses: actions/github-script@v7
        env:
          OS: ${{ matrix.os }}
        with:
          script: |
            const fs = require('fs');
            const path = 'reports/spectral.json';
            let issues = [];
            if (fs.existsSync(path)) {
              try { issues = JSON.parse(fs.readFileSync(path,'utf8')); } catch {}
            }
            const sevMap = {0:'error',1:'warn',2:'info',3:'hint'};
            const counts = { error:0, warn:0, info:0, hint:0 };
            const byRule = {};
            for (const it of issues) {
              const sev = typeof it.severity==='number' ? (sevMap[it.severity]||'info') : (it.severity||'info');
              counts[sev] = (counts[sev]||0) + 1;
              const code = it.code || 'unknown';
              byRule[code] = (byRule[code]||0) + 1;
            }
            const top = Object.entries(byRule).sort((a,b)=>b[1]-a[1]).slice(0,5);
            let md = `### Spectral Summary (${process.env.OS})\n\n`;
            md += `- errors: ${counts.error||0}, warnings: ${counts.warn||0}, info: ${counts.info||0}\n`;
            if (top.length) {
              md += `\n| Rule | Count |\n|---|---:|\n`;
              for (const [rule,cnt] of top) md += `| ${rule} | ${cnt} |\n`;
            }
            await core.summary.addRaw(md).write();

      - name: ?? Upload smoke summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-summary-${{ matrix.os }}-${{ github.sha }}
          path: reports/smoke_summary.json
          if-no-files-found: warn

  smoke-summary:
    name: Smoke PR Summary
    needs: [smoke]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: 🔄 Download smoke artifacts
        uses: actions/download-artifact@v4
        with:
          path: smoke_reports
          pattern: smoke-summary-*
          merge-multiple: true

      - name: 📝 Comment PR with p95 summary
        # Skip when PR is from a fork to avoid 403
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            function findFiles(dir, target) {
              let out = [];
              for (const ent of fs.readdirSync(dir, { withFileTypes: true })) {
                const p = path.join(dir, ent.name);
                if (ent.isDirectory()) out = out.concat(findFiles(p, target));
                else if (ent.isFile() && ent.name === target) out.push(p);
              }
              return out;
            }
            const base = 'smoke_reports';
            let rows = [];
            if (fs.existsSync(base)) {
              for (const p of findFiles(base, 'smoke_summary.json')) {
                const txt = fs.readFileSync(p, 'utf-8');
                try {
                  const j = JSON.parse(txt);
                  // best-effort infer OS from path
                  const parts = p.split(path.sep);
                  const art = parts.find(x => x.startsWith('smoke-summary-')) || '';
                  const os = art.replace('smoke-summary-','').replace(/-.+$/, '') || 'unknown';
                  rows.push({ os, ...j });
                } catch {}
              }
            }
            if (rows.length === 0) {
              core.warning('No smoke summaries found');
              return;
            }
            rows.sort((a,b)=> a.os.localeCompare(b.os));
            let body = `### Smoke Summary (p95)\n\n`;
            body += `| OS | total | passes | fails | p95_ms | threshold_ms |\n|---|---:|---:|---:|---:|---:|\n`;
            for (const r of rows) {
              body += `| ${r.os} | ${r.total} | ${r.passes} | ${r.fails} | ${r.p95_ms} | ${r.threshold_ms || ''} |\n`;
            }
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            } catch (err) {
              core.warning(`Could not create PR comment: ${err?.message || err}`);
            }

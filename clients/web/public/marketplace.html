<!--
+-------------------------------------------------------------+
|                          CERTEUS                            |
+-------------------------------------------------------------+
| FILE: clients/web/public/marketplace.html                  |
| ROLE: Web client page.                                      |
| PLIK: clients/web/public/marketplace.html                  |
| ROLA: Strona marketplace wtyczek.                           |
+-------------------------------------------------------------+
-->
<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CERTEUS — Marketplace</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; padding: 0; background: #0f1115; color: #e5e7eb; }
      .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
      h1, h2 { margin: 8px 0; }
      .card { background: #161a20; border: 1px solid #232832; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { text-align: left; padding: 8px; border-bottom: 1px solid #2a2f3a; }
      .row { display: grid; gap: 8px; margin: 8px 0; }
      textarea, input[type="text"] { width: 100%; background: #0f1319; color: #e5e7eb; border: 1px solid #2a2f3a; border-radius: 8px; padding: 8px; }
      button { background: #2563eb; border: none; color: #fff; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-weight: 700; }
      button:hover { background: #1d4ed8; }
      .muted { color: #9aa0a6; }
      .ok { color: #22c55e; }
      .bad { color: #ef4444; }
      .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
      @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
      .diffgrid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 8px; }
      .diffgrid pre { background: #0f1319; border: 1px solid #2a2f3a; border-radius: 8px; padding: 8px; overflow: auto; }
      .dl { display: block; white-space: pre; }
      .dl.add { color: #22c55e; background: #22c55e1a; }
      .dl.rem { color: #ef4444; background: #ef44441a; }
      .dl.eq { color: #e5e7eb; opacity: 0.8; }
      mark { background: #ef44441a; color: #ef4444; padding: 0 2px; border-radius: 3px; }
      .legend { display:flex; gap:10px; align-items:center; font-size: 12px; color:#9aa0a6; }
      .legend .sw { display:inline-block; width:12px; height:12px; border-radius:3px; vertical-align:middle; margin-right:4px; }
      .legend .sw.add { background:#22c55e; }
      .legend .sw.rem { background:#ef4444; }
      .legend .sw.mod { background:#ef4444; opacity: 0.6; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>CERTEUS — Marketplace wtyczek</h1>
      <p class="muted">Lista zainstalowanych wtyczek oraz instalacja przez podpisany manifest.</p>

      <div class="card">
        <h2>Wtyczki</h2>
        <table id="tbl"><thead><tr><th>Nazwa</th><th>Moduł</th><th>Wersja</th><th>Podpis</th><th>Caps</th></tr></thead><tbody id="tbody"><tr><td colspan="5" class="muted">Ładowanie…</td></tr></tbody></table>
      </div>

      <div class="card">
        <h2>Klucz publiczny (Ed25519)</h2>
        <div id="pubkey" class="muted">—</div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>Weryfikacja podpisu</h2>
          <div class="row">
            <label for="verify-man" title="Wklej manifest YAML bez linii 'signature:'">Manifest YAML (bez linii signature:)</label>
            <textarea id="verify-man" rows="8" placeholder="name: demo_alpha
module: plugins.demo_alpha.src.main
version: '0.1.0'"></textarea>
          </div>
          <div class="row">
            <label title="Załaduj plik YAML manifestu">Wgraj plik manifestu (opcjonalnie)</label>
            <input type="file" id="verify-file" accept=".yaml,.yml,text/yaml,text/plain" />
          </div>
          <div class="row">
            <label for="verify-sig" title="Podpis Ed25519 w base64url (bez '=')">Podpis (base64url, Ed25519)</label>
            <input type="text" id="verify-sig" placeholder="b64u..." />
          </div>
          <div class="row">
            <button id="btn-verify" title="Ręczne sprawdzenie podpisu">Zweryfikuj</button>
            <div id="verify-out" class="muted" aria-live="polite" aria-atomic="true"></div>
          </div>
        </div>
        <div class="card">
          <h2>Instalacja/upgrade</h2>
          <div class="row">
            <label for="install-name" title="Nazwa folderu w plugins/ (A‑Z, a‑z, 0‑9, '-', '_')">Nazwa pakietu (folder w plugins/)</label>
            <input type="text" id="install-name" placeholder="demo_alpha" />
          </div>
          <div class="row">
            <label for="install-man" title="Wklej manifest YAML bez 'signature:'">Manifest YAML (bez linii signature:)</label>
            <textarea id="install-man" rows="8"></textarea>
          </div>
          <div class="row">
            <label title="Załaduj plik YAML manifestu">Wgraj plik manifestu (opcjonalnie)</label>
            <input type="file" id="install-file" accept=".yaml,.yml,text/yaml,text/plain" />
          </div>
          <div class="row">
            <label for="install-sig" title="Podpis Ed25519 w base64url (bez '=')">Podpis (base64url, Ed25519)</label>
            <input type="text" id="install-sig" />
          </div>
          <div class="row">
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <button id="btn-dryrun" class="neutral" title="Sprawdź nazwę/podpis bez instalacji">Dry‑Run</button>
              <button id="btn-fetch-installed" class="neutral" title="Porównaj z aktualnie zainstalowanym manifestem">Pobierz zainstalowany manifest</button>
              <button id="btn-install" title="Zainstaluj manifest po udanym dry‑run">Zainstaluj</button>
              <span id="install-out" class="muted"></span>
            </div>
            <div id="dryrun-report" class="muted" style="white-space:pre-wrap"></div>
            <div id="diff" class="muted"></div>
            <div id="diff-yaml" class="diffgrid"></div>
            <div id="diff-legend" class="legend">
              <span><span class="sw add" aria-hidden="true"></span>Dodano</span>
              <span><span class="sw rem" aria-hidden="true"></span>Usunięto</span>
              <span><span class="sw mod" aria-hidden="true"></span>Zmiana (podświetlenie)</span>
            </div>
            <div class="row">
              <label for="dryrun-history">Historia dry‑run (localStorage)</label>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; width:100%">
                <select id="dryrun-history" style="flex:1 1 260px" title="Wybierz poprzedni dry‑run"></select>
                <button id="btn-load-dryrun" title="Załaduj do formularza">Załaduj</button>
                <button id="btn-install-from-hist" title="1‑klik instalacja wybranego" disabled>Zainstaluj z historii</button>
                <span id="dryrun-hint" class="muted"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      const API = location.origin;
      async function api(path, init) {
        const r = await fetch(API + path, { headers: { 'Content-Type': 'application/json' }, ...init });
        const ct = r.headers.get('content-type') || '';
        const body = ct.includes('application/json') ? await r.json() : await r.text();
        if (!r.ok) throw new Error(typeof body === 'string' ? body : (body.detail || 'HTTP ' + r.status));
        return body;
      }
      async function loadPlugins() {
        const tb = document.getElementById('tbody');
        try {
          const data = await api('/v1/marketplace/plugins');
          window.__PLUGS = data || [];
          if (!data || !data.length) { tb.innerHTML = '<tr><td colspan="5" class="muted">Brak wtyczek</td></tr>'; return; }
          tb.innerHTML = data.map(p => `<tr><td>${p.name}</td><td>${p.module||''}</td><td>${p.version||''}</td><td>${p.signed?'<span class=ok>TAK</span>':'<span class=bad>NIE</span>'}</td><td>${(p.capabilities||p.caps||[]).join(', ')}</td></tr>`).join('');
        } catch (e) {
          tb.innerHTML = `<tr><td colspan="5" class="bad">Błąd: ${e.message||e}</td></tr>`;
        }
      }
      async function loadPubkey() {
        const el = document.getElementById('pubkey');
        try {
          const res = await api('/v1/marketplace/pubkey');
          el.textContent = res.ed25519_pubkey_b64url || 'brak/nieustawiony (ENV ED25519_PUBKEY_B64URL)';
        } catch (e) { el.textContent = 'błąd: '+(e.message||e); }
      }
      document.getElementById('verify-file').addEventListener('change', (ev) => {
        const f = ev.target.files && ev.target.files[0]; if (!f) return;
        f.text().then(t => { document.getElementById('verify-man').value = t; });
      });
      document.getElementById('install-file').addEventListener('change', (ev) => {
        const f = ev.target.files && ev.target.files[0]; if (!f) return;
        f.text().then(t => { document.getElementById('install-man').value = t; });
      });
      function basicYamlCheck(txt){
        // bardzo prosta walidacja: musi mieć co najmniej 'module:'
        return /\bmodule\s*:\s*[^\n]+/.test(txt);
      }
      document.getElementById('btn-verify').addEventListener('click', async () => {
        const man = document.getElementById('verify-man').value;
        const sig = document.getElementById('verify-sig').value.trim();
        const out = document.getElementById('verify-out');
        out.textContent = 'Pracuję...';
        try {
          if (!basicYamlCheck(man)) throw new Error('Manifest: brak pola module:');
          const res = await api('/v1/marketplace/verify_manifest', { method: 'POST', body: JSON.stringify({ manifest_yaml: man, signature_b64u: sig }) });
          out.textContent = res.ok ? 'OK: podpis poprawny' : 'BŁĄD: podpis nieprawidłowy';
          out.className = res.ok ? 'ok' : 'bad';
        } catch (e) {
          out.textContent = 'BŁĄD: ' + (e.message||e);
          out.className = 'bad';
        }
      });
      document.getElementById('btn-install').addEventListener('click', async () => {
        const name = document.getElementById('install-name').value.trim();
        const man = document.getElementById('install-man').value;
        const sig = document.getElementById('install-sig').value.trim();
        const out = document.getElementById('install-out');
        out.textContent = 'Pracuję...';
        try {
          if (!basicYamlCheck(man)) throw new Error('Manifest: brak pola module:');
          const res = await api('/v1/marketplace/install', { method: 'POST', body: JSON.stringify({ name, manifest_yaml: man, signature_b64u: sig }) });
          out.textContent = 'OK: ' + JSON.stringify(res);
          out.className = 'ok';
          await loadPlugins();
        } catch (e) {
          out.textContent = 'BŁĄD: ' + (e.message||e);
          out.className = 'bad';
        }
      });
      function markDiff(a,b){
        a = String(a||''); b = String(b||'');
        if (a===b) return `<code>${a||'(brak)'}</code> → <code>${b||'(brak)'}</code>`;
        let i=0; while(i<a.length && i<b.length && a[i]===b[i]) i++;
        let j=0; while(j<a.length-i && j<b.length-i && a[a.length-1-j]===b[b.length-1-j]) j++;
        const aMid = a.slice(i, a.length-j), bMid = b.slice(i, b.length-j);
        const aHtml = `${a.slice(0,i)}<mark>${aMid||'∅'}</mark>${a.slice(a.length-j)}`;
        const bHtml = `${b.slice(0,i)}<mark>${bMid||'∅'}</mark>${b.slice(b.length-j)}`;
        return `<code>${aHtml||'(brak)'}</code> → <code>${bHtml||'(brak)'}</code>`;
      }
      function semverRisk(from, to){
        const rx=/^(\d+)\.(\d+)\.(\d+)/; const m1=String(from||'').match(rx); const m2=String(to||'').match(rx);
        if(!m1||!m2) return 'unknown';
        const a=[+m1[1],+m1[2],+m1[3]], b=[+m2[1],+m2[2],+m2[3]];
        if (b[0]>a[0]) return 'major'; if (b[0]<a[0]) return 'downgrade';
        if (b[1]>a[1]) return 'minor'; if (b[1]<a[1]) return 'downgrade';
        if (b[2]>a[2]) return 'patch'; if (b[2]<a[2]) return 'downgrade';
        return 'same';
      }
      document.getElementById('btn-dryrun').addEventListener('click', async () => {
        const name = document.getElementById('install-name').value.trim();
        const man = document.getElementById('install-man').value;
        const sig = document.getElementById('install-sig').value.trim();
        const rep = document.getElementById('dryrun-report');
        const diff = document.getElementById('diff');
        rep.textContent = 'Analiza...'; diff.textContent='';
        try {
          if (!basicYamlCheck(man)) throw new Error('Manifest: brak pola module:');
          const res = await api('/v1/marketplace/dry_run', { method: 'POST', body: JSON.stringify({ name, manifest_yaml: man, signature_b64u: sig }) });
          const errs = res.errors || [];
          rep.textContent = (res.ok? 'OK' : 'BŁĘDY: ' + errs.join(', ')) + '\nmodule: '+(res.module||'-')+'\nversion: '+(res.version||'-')+'\npath: '+res.would_write_path;
          rep.className = res.ok ? 'ok' : 'bad';
          // Pokaż diff wersji vs zainstalowany
          const existing = (window.__PLUGS||[]).find(p=>p.name===name);
          if (existing) {
            const from = existing.version || '(brak)'; const to = res.version || '(brak)';
            const modFrom = existing.module || '(?)'; const modTo = res.module || '(?)';
            const risk = semverRisk(from,to);
            diff.innerHTML = `<div>Aktualizacja: <strong>${name}</strong> [ryzyko: <em>${risk}</em>]<br>module: ${markDiff(modFrom,modTo)}<br>version: ${markDiff(from,to)}</div>`;
          } else {
            diff.textContent = '';
          }
          // Zablokuj instalację jeśli błędy
          document.getElementById('btn-install').disabled = !res.ok;
        } catch (e) {
          rep.textContent = 'BŁĄD: ' + (e.message||e);
          rep.className = 'bad';
        }
      });
      document.getElementById('btn-fetch-installed').addEventListener('click', async () => {
        const name = document.getElementById('install-name').value.trim();
        const diffBox = document.getElementById('diff-yaml'); diffBox.innerHTML='';
        if (!name) { diffBox.textContent = 'Podaj nazwę pakietu.'; return; }
        try {
          const res = await api('/v1/marketplace/plugin_manifest/'+encodeURIComponent(name));
          const inst = String(res.manifest_yaml||'').split('\n');
          const cur = String(document.getElementById('install-man').value||'').split('\n');
          const left = [], right = [];
          const N = Math.max(inst.length, cur.length);
          for (let i=0;i<N;i++) {
            const a = inst[i]||''; const b = cur[i]||'';
            left.push((a===b? '  ' : '- ') + a);
            right.push((a===b? '  ' : '+ ') + b);
          }
          diffBox.innerHTML = `<div class="muted">Porównanie linii (zainstalowany ⇄ obecny formularz)</div>`+
            `<div style="display:grid; gap:8px; grid-template-columns:1fr 1fr;">`+
            `<pre>${left.map(x=>x.replace(/</g,'&lt;')).join('\n')}</pre>`+
            `<pre>${right.map(x=>x.replace(/</g,'&lt;')).join('\n')}</pre>`+
            `</div>`;
        } catch (e) {
          diffBox.textContent = 'BŁĄD: ' + (e.message||e);
        }
      });
      // Drag&drop do textarea (install)
      ;['install-man','verify-man'].forEach(id=>{
        const ta = document.getElementById(id);
        ta.addEventListener('dragover', ev=>{ ev.preventDefault(); ta.style.outline='2px dashed #60a5fa'; });
        ta.addEventListener('dragleave', ()=>{ ta.style.outline=''; });
        ta.addEventListener('drop', ev=>{
          ev.preventDefault(); ta.style.outline=''; const f=ev.dataTransfer.files && ev.dataTransfer.files[0]; if(!f) return; f.text().then(t=>ta.value=t);
        });
      });
      loadPlugins();
      loadPubkey();
    </script>
  </body>
  </html>

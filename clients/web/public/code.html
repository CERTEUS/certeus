<!--
+-------------------------------------------------------------+
|                          CERTEUS                            |
+-------------------------------------------------------------+
| FILE: clients/web/public/code.html                          |
| ROLE: Web client page.                                      |
| PLIK: clients/web/public/code.html                          |
| ROLA: Strona klienta web (CODE).                            |
+-------------------------------------------------------------+
-->

<!doctype html>
<html lang="pl" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CERTEUS • CODE View</title>
    <style>
      body {
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial;
        margin: 0;
        background: #111315;
        color: #f2f2f3;
      }
      .container {
        max-width: 980px;
        margin: 24px auto;
        padding: 0 16px;
      }
      .card {
        background: #181b20;
        border: 1px solid #2a2d33;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
      }
      h1 {
        margin: 0 0 10px;
        font-size: 22px;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      .btn {
        background: #1a1c20;
        border: 1px solid #2a2d33;
        color: #f2f2f3;
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      .btn:hover {
        background: #20242a;
      }
      .muted {
        color: #9aa0a6;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border-bottom: 1px solid #2a2d33;
        padding: 8px 10px;
        text-align: left;
      }
      .pill {
        display: inline-block;
        padding: 4px 8px;
        border: 1px solid #2a2d33;
        border-radius: 999px;
        background: #20242a;
        margin-left: 8px;
      }
      input,
      textarea {
        background: #1a1c20;
        border: 1px solid #2a2d33;
        border-radius: 10px;
        color: #f2f2f3;
        padding: 8px 10px;
      }
      .tag {
        display: inline-block;
        margin-right: 6px;
        margin-bottom: 4px;
        padding: 2px 6px;
        border-radius: 8px;
        border: 1px solid #2a2d33;
        background: #20242a;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <a
      href="#main"
      class="sr-only sr-only-focusable"
      aria-label="Skip to main content"
      >Pomiń do treści głównej</a
    >
    <main id="main" role="main">
      <div class="container">
        <div class="row" style="justify-content: space-between; align-items: baseline; margin-bottom: 8px">
          <nav aria-label="Nawigacja">
            <a href="/app/public/index.html">Cockpit</a>
            <a href="/app/public/marketplace.html">Marketplace</a>
            <a href="/app/public/chatops.html">ChatOps</a>
            <a href="/app/public/mailops.html">MailOps</a>
            <a href="/app/public/export.html">Export</a>
          </nav>
          <label class="muted" for="lang">Lang</label>
          <select id="lang" aria-label="Language select" class="btn">
            <option value="pl" selected>PL</option>
            <option value="en">EN</option>
          </select>
        </div>
        <div class="card">
          <h1 id="title-code" data-i18n="title">CODE • Domain Packs</h1>
          <div class="row" style="margin-bottom: 8px">
            <input id="q" placeholder="filtruj" aria-label="Filtr" />
            <button class="btn" id="refresh" data-i18n="refresh">
              Odśwież
            </button>
            <span class="muted"
              ><span data-i18n="count_label">Liczba</span>:
              <span id="count" class="pill">0</span></span
            >
          </div>
          <table>
            <thead>
              <tr>
                <th>Nazwa</th>
                <th>Wersja</th>
                <th>ABI</th>
                <th>Status</th>
                <th>Akcja</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
        <div class="card">
          <h1 data-i18n="try_title">Try • TPL diff (demo)</h1>
          <div class="row" style="margin-bottom: 8px">
            <input id="pack" placeholder="pack name (np. tpl_diff_pl)" />
            <button class="btn" id="try">Try</button>
          </div>
          <textarea id="payload" rows="8" style="width: 100%">
{
  "act_id": "DEMO-ACT",
  "v_from": "v1",
  "v_to": "v2"
}</textarea
          >
          <pre
            id="out"
            style="
              background: #0f1115;
              border: 1px solid #2a2d33;
              padding: 12px;
              border-radius: 8px;
              overflow: auto;
              max-height: 280px;
              margin-top: 8px;
            "
          ></pre>
        </div>
      </div>
    </main>
    <script>
      async function listPacks() {
        const r = await fetch("/v1/packs/");
        return r.ok ? await r.json() : [];
      }
      function render(packs) {
        const q = (document.getElementById("q").value || "").toLowerCase();
        const filtered = packs.filter(
          (p) => !q || (p.name || "").toLowerCase().includes(q),
        );
        const tb = document.getElementById("rows");
        tb.innerHTML = filtered
          .map((p) => {
            const status = `${p.enabled ? '<span class="pill">enabled</span>' : ""} ${p.signature ? '<span class="pill">signed</span>' : ""}`;
            const btn = `<button class=\"btn try\" data-pack=\"${p.name}\">Try</button>`;
            return `<tr><td>${p.name}</td><td>${p.version || "-"}</td><td><code>${p.abi}</code></td><td>${status}</td><td>${btn}</td></tr>`;
          })
          .join("");
        document.getElementById("count").textContent = String(filtered.length);
        Array.from(document.querySelectorAll("button.try")).forEach((btn) => {
          btn.onclick = () => {
            document.getElementById("pack").value =
              btn.getAttribute("data-pack");
          };
        });
      }
      async function refresh() {
        render(await listPacks());
      }
      document.getElementById("refresh").onclick = refresh;
      document.getElementById("q").oninput = refresh;
      document.getElementById("try").onclick = async () => {
        const name = (document.getElementById("pack").value || "").trim();
        let payload = {};
        try {
          const raw = document.getElementById("payload").value;
          if (raw.trim()) payload = JSON.parse(raw);
        } catch (_) {}
        const r = await fetch("/v1/packs/try", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ pack: name, payload }),
        });
        const j = await r.json();
        document.getElementById("out").textContent = JSON.stringify(j, null, 2);
      };
      const I18N = {
        pl: {
          title: "CODE • Pakiety domenowe",
          refresh: "Odśwież",
          count_label: "Liczba",
          try_title: "Try • TPL diff (demo)",
        },
        en: {
          title: "CODE • Domain Packs",
          refresh: "Refresh",
          count_label: "Count",
          try_title: "Try • TPL diff (demo)",
        },
      };
      function getLang() {
        const u = new URL(location.href);
        const p = (u.searchParams.get("lang") || "").toLowerCase();
        return p === "en" || p === "pl" ? p : "pl";
      }
      function applyI18n() {
        const lang = getLang();
        const d = I18N[lang] || I18N.pl;
        document.getElementById("title-code").textContent = d.title;
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const k = el.getAttribute("data-i18n");
          if (d[k]) el.textContent = d[k];
        });
        const sel = document.getElementById("lang");
        sel.value = lang;
        sel.onchange = () => {
          const url = new URL(location.href);
          url.searchParams.set("lang", sel.value);
          location.href = url.toString();
        };
      }
      applyI18n();
      refresh();
    </script>
    <style>
      :focus-visible {
        outline: 2px solid #8a8f98;
        outline-offset: 2px;
      }
      .sr-only {
        position: absolute;
        left: -10000px;
        top: auto;
        width: 1px;
        height: 1px;
        overflow: hidden;
      }
      .sr-only-focusable:focus {
        position: static;
        width: auto;
        height: auto;
        padding: 8px 10px;
        margin: 6px;
        background: #181b20;
        border: 2px solid #8a8f98;
        border-radius: 8px;
      }
    </style>
  </body>
</html>

<!--
+-------------------------------------------------------------+
|                          CERTEUS                            |
+-------------------------------------------------------------+
| FILE: clients/web/public/qtm.html                          |
| ROLE: Web client page.                                      |
| PLIK: clients/web/public/qtm.html                          |
| ROLA: Strona klienta web.                                   |
+-------------------------------------------------------------+
-->

<!doctype html>
<html lang="pl" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CERTEUS • QTMP</title>
    <style>
      body {
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial;
        margin: 0;
        background: #111315;
        color: #f2f2f3;
      }
      .container {
        max-width: 980px;
        margin: 24px auto;
        padding: 0 16px;
      }
      .card {
        background: #181b20;
        border: 1px solid #2a2d33;
        border-radius: 12px;
        padding: 16px;
      }
      h1 {
        margin: 0 0 10px;
        font-size: 22px;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      .btn {
        background: #1a1c20;
        border: 1px solid #2a2d33;
        color: #f2f2f3;
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      .btn:hover {
        background: #20242a;
      }
      .muted {
        color: #9aa0a6;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 2px;
        margin-top: 8px;
      }
      .cell {
        width: 18px;
        height: 18px;
        background: #20242a;
        border-radius: 2px;
        position: relative;
      }
      .cell.hot {
        background: #f2c8cc;
      }
      .cell.cold {
        background: #c8f2d2;
      }
      .cell:hover::after {
        content: attr(data-tip);
        position: absolute;
        left: 20px;
        top: -10px;
        background: #1a1c20;
        border: 1px solid #2a2d33;
        padding: 4px 6px;
        border-radius: 6px;
        white-space: nowrap;
        font-size: 12px;
      }
      a {
        color: #9aa0a6;
      }
      .pill {
        display: inline-block;
        padding: 4px 8px;
        border: 1px solid #2a2d33;
        border-radius: 999px;
        background: #20242a;
        margin-left: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>QTMP • Measurement cockpit</h1>
        <div class="row">
          <input id="case" class="btn" placeholder="case id (np. LEX-001)" />
          <button id="init" class="btn">Init case</button>
          <button id="lt" class="btn">Measure L→T</button>
          <button id="tl" class="btn">Measure T→L</button>
          <button id="lockDeco" class="btn">Decoherence: dephasing</button>
          <span id="status" class="muted"></span>
        </div>
        <div class="row" style="margin-top:8px;">
          <span class="muted">Operator Composer:</span>
          <label class="muted"><input type="radio" name="op" value="W" checked /> W</label>
          <label class="muted"><input type="radio" name="op" value="I" /> I</label>
          <label class="muted"><input type="radio" name="op" value="C" /> C</label>
          <label class="muted"><input type="radio" name="op" value="L" /> L</label>
          <label class="muted"><input type="radio" name="op" value="T" /> T</label>
          <button id="savePreset" class="btn">Save preset</button>
          <button id="loadPreset" class="btn">Load preset</button>
          <span id="presetStatus" class="muted"></span>
        </div>
        <p class="muted">
          Uncertainty L_T: <span id="ub" class="pill">?</span>, collapse:
          <span id="collapse" class="pill">-</span>
        </p>
        <div id="heat" class="grid"></div>
        <p class="muted">
          Case ledger: <a id="caseLink" href="#" target="_blank">open</a>
        </p>
      </div>
      <div class="card" style="margin-top:16px;">
        <h1>QTMP • Commutator heatmap</h1>
        <div class="row" style="margin-bottom:10px;">
          <button id="heatmap" class="btn">Build heatmap</button>
          <span class="muted">0=commute • 1=max non‑commute</span>
        </div>
        <table id="cmt" style="width:100%;border-collapse:collapse;">
          <thead>
            <tr>
              <th></th>
              <th>W</th>
              <th>I</th>
              <th>C</th>
              <th>L</th>
              <th>T</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <script>
      async function fetchJSON(url, opts) {
        const r = await fetch(url, opts);
        const j = await r.json();
        return { ok: r.ok, data: j, headers: r.headers };
      }
      function paintHeat(v) {
        const grid = document.getElementById("heat");
        grid.innerHTML = "";
        const n = 32;
        for (let i = 0; i < n; i++) {
          const d = document.createElement("div");
          const h = v + (Math.random() - 0.5) * 0.1;
          d.className = "cell " + (h > 0.5 ? "hot" : "cold");
          d.dataset.tip = `commutator heat=${h.toFixed(2)}`;
          grid.appendChild(d);
        }
      }
      async function initCase() {
        const cs = document.getElementById("case").value || "LEX-001";
        const r = await fetchJSON("/v1/qtm/init_case", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            case: cs,
            basis: ["ALLOW", "DENY", "ABSTAIN"],
          }),
        });
        document.getElementById("status").textContent = r.ok
          ? "initialized"
          : "init failed";
      }
      function q(k){ return new URLSearchParams(location.search).get(k)||''; }
      async function autoRun(){
        const cs = q('case') || '';
        const op = (q('op')||'').toUpperCase();
        const autorun = q('auto');
        if(cs){ document.getElementById('case').value = cs; await initCase(); }
        if(autorun==='1' && (op==='LT' || op==='TL')){ await measure(op); }
      }
      function colorForValue(v){
        // v in [0,1]; green (0) -> red (1)
        const r = Math.round(255 * v);
        const g = Math.round(200 * (1 - v));
        return `rgb(${r},${g},120)`;
      }
      async function buildHeatmap(){
        const ops = ['W','I','C','L','T'];
        const tb = document.querySelector('#cmt tbody');
        if(!tb) return;
        tb.innerHTML='';
        for(const A of ops){
          const tr = document.createElement('tr');
          const th = document.createElement('th'); th.textContent = A; th.className='muted'; th.style.textAlign='left'; tr.appendChild(th);
          for(const B of ops){
            const td = document.createElement('td'); td.style.height='22px'; td.style.textAlign='center'; td.style.borderBottom='1px solid #2a2d33';
            try{
              const r = await fetchJSON('/v1/qtm/commutator', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({A,B})});
              const v = r.ok ? Number(r.data?.value||0) : 0;
              td.style.background = colorForValue(Math.max(0, Math.min(1, v)));
              td.title = `${A},${B} = ${v}`;
              td.textContent = v.toFixed(2);
            }catch(e){ td.textContent='-'; }
            tr.appendChild(td);
          }
          tb.appendChild(tr);
        }
      }
      async function measure(op) {
        const cs = document.getElementById("case").value || "LEX-001";
        let ub = '?';
        let collapseText = '-';
        // If operator represents a sequence (LT/TL), use measure_sequence for a nicer UI
        if (op === 'LT' || op === 'TL') {
          const r = await fetchJSON('/v1/qtm/measure_sequence', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ operators: op.split(''), case: cs })
          });
          if (r.ok) {
            ub = r.data?.uncertainty_bound?.L_T ?? '?';
            collapseText = (r.data?.steps || []).map(s => `${s.operator}:${s.verdict}@${(s.p||0).toFixed(2)}`).join(', ');
          }
        } else {
          const r = await fetchJSON("/v1/qtm/measure", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ operator: op, source: cs }),
          });
          ub = r.data?.uncertainty_bound?.L_T ?? "?";
          collapseText = r.headers.get("X-CERTEUS-PCO-qtm.collapse_event") || "-";
        }
        document.getElementById("ub").textContent = ub;
        document.getElementById("collapse").textContent = collapseText;
        document.getElementById("caseLink").href = `/v1/ledger/${encodeURIComponent(cs)}/records`;
        paintHeat(ub || 0.25);
      }
      async function setDeco() {
        const cs = document.getElementById("case").value || "LEX-001";
        await fetchJSON("/v1/qtm/decoherence", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ case: cs, channel: "dephasing" }),
        });
        document.getElementById("status").textContent =
          "decoherence: dephasing";
      }
      document.getElementById("init").addEventListener("click", initCase);
      document
        .getElementById("lt")
        .addEventListener("click", () => measure("LT"));
      document
        .getElementById("tl")
        .addEventListener("click", () => measure("TL"));
      document.getElementById("lockDeco").addEventListener("click", setDeco);
      document.getElementById("heatmap")?.addEventListener("click", buildHeatmap);
      document.getElementById("savePreset").addEventListener("click", async ()=>{
        const cs = document.getElementById('case').value || 'LEX-001';
        const sel = document.querySelector('input[name="op"]:checked');
        const op = sel ? sel.value : 'W';
        const r = await fetchJSON('/v1/qtm/preset', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({case: cs, operator: op})});
        document.getElementById('presetStatus').textContent = r.ok ? `saved: ${op}` : 'save failed';
      });
      document.getElementById("loadPreset").addEventListener("click", async ()=>{
        const cs = document.getElementById('case').value || 'LEX-001';
        const r = await fetchJSON(`/v1/qtm/preset/${encodeURIComponent(cs)}`);
        if(r.ok){
          const op = r.data?.operator||'W';
          const sel = document.querySelector(`input[name="op"][value="${op}"]`);
          if(sel) sel.checked = true;
          document.getElementById('presetStatus').textContent = `loaded: ${op}`;
        } else {
          document.getElementById('presetStatus').textContent = 'no preset';
        }
      });
      autoRun();
    </script>
  </body>
</html>

# Release Guide

This document describes the recommended release process for CERTEUS.

## Versioning

- Semantic Versioning: `MAJOR.MINOR.PATCH`.
- Source of truth: `core/version.py` (`__version__`).
- API and services import the version for consistency.

## Pre-release Checklist

- Lint and tests: `ruff check . --fix && ruff format . && pytest -q` (see `README`)
- OpenAPI validated and published (workflow `openapi-pages`)
- DoD status: `docs/DoD_checklist.md`
- SBOM/Trivy/Cosign/SLSA: workflow `supply-chain` green
- Smoke job (MUST): workflow `Smoke` green (Ubuntu + Windows)
  - Kryteria: `fails == 0`, `p95_ms <= SLO_MAX_P95_MS` (domyślnie 250 ms) w podsumowaniu skryptu
  - Lokalny rerun: `pwsh -File .\scripts\smoke_api.ps1` (Windows) lub `bash ./scripts/smoke_api.sh` (Linux/macOS)
  - Debug: `PROOF_VERIFY_DEBUG=1`, możliwe mocki `PROOF_VERIFIER_MOCK=lfsc_ok|drat_ok` (tylko DEV)

## Cut a Release

1. Update `core/version.py` to the target version (e.g., `1.0.0`).
2. Create a tag:

```
git commit -am "chore(release): v1.0.0"
git tag -a v1.0.0 -m "v1.0.0"
git push origin v1.0.0
```

3. GitHub Actions `release` workflow will:
   - Build & push Docker images to GHCR:
     - `ghcr.io/<owner>/<repo>-api:<tag|latest|sha>`
     - `ghcr.io/<owner>/<repo>-proofgate:<tag|latest|sha>`
  - Create GitHub Release with autogenerated notes.

## Branch Protection: wymagane checki (Smoke)

Aby egzekwować przejście Smoke na PR, włącz wymagane status checks dla gałęzi `main`:

1) Utwórz repo secret `ADMIN_TOKEN` (GitHub classic PAT z uprawnieniem `repo`).
2) Uruchom workflow ręcznie: Actions → Enforce Branch Protection (Smoke Required) → Run workflow (branch: `main`).
3) Workflow ustawi wymagane checki: “Smoke (ubuntu-latest)” i “Smoke (windows-latest)”.

Uwaga: Job `smoke-summary` dodaje komentarz do PR z tabelą p95 per-OS oraz progami. Artefakt `reports/smoke_summary.json` jest dołączany do runu.

## Post-release

- Verify images in GHCR and that OpenAPI Pages serve the latest JSON
- Optionally tag the dashboard version or export it to a Grafana instance

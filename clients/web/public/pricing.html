<!--
+-------------------------------------------------------------+
|                          CERTEUS                            |
+-------------------------------------------------------------+
| FILE: clients/web/public/pricing.html                       |
| ROLE: Interactive Pricing (tiers + estimator)               |
| PLIK: clients/web/public/pricing.html                       |
| ROLA: Interaktywny cennik                                    |
+-------------------------------------------------------------+
-->
<!doctype html>
<html lang="pl" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CERTEUS • Pricing</title>
    <style>
      body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#0f1114;color:#f2f2f3}
      .wrap{max-width:1100px;margin:24px auto;padding:0 12px}
      .card{background:#151922;border:1px solid #232832;border-radius:12px;padding:12px;margin-bottom:12px}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #232832;padding:8px;text-align:left}
      input,select{background:#0f1114;border:1px solid #232832;border-radius:8px;color:#f2f2f3;padding:8px}
      .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
      .btn{padding:8px 12px;border:1px solid #232832;border-radius:8px;background:#1a1f29;color:#f2f2f3;cursor:pointer}
      .muted{color:#9aa0a6}
    </style>
  </head>
  <body>
    <a href="#main" class="sr-only sr-only-focusable">Pomiń do treści głównej</a>
    <main id="main" role="main">
    <div class="wrap">
      <div class="card">
        <h1>Pricing & Tiers</h1>
        <p class="muted">Dane z `/v1/billing/policies`. Szacunki bazują na `/v1/billing/estimate`.</p>
        <div id="tiers"></div>
      </div>
      <div class="card">
        <h2>Estimator</h2>
        <div class="row">
          <label>Tenant: <input id="tenant" value="anonymous"/></label>
          <label>Action: <select id="act"><option>qtm.measure</option><option>qtm.decoherence</option><option>system.analyze</option><option>ingest.upload</option><option>lexqft.tunnel</option><option>proofgate.publish</option></select></label>
          <label>Times per month: <input id="count" type="number" value="1000"/></label>
          <label>Days: <input id="days" type="number" value="30"/></label>
          <button id="calc" class="btn">Calculate</button>
        </div>
        <p id="out" class="muted"></p>
        <div id="rec" class="muted"></div>
      </div>
      <div class="card">
        <h2>Heatmap (action × tier × volume)</h2>
        <p class="muted">Kolor: zielony=OK, żółty=blisko limitu (&lt; 10% marginesu), czerwony=przekroczony.</p>
        <div class="row">
          <label>Days: <input id="hDays" type="number" value="30"/></label>
          <label>Volumes/mo:
            <select id="hVol">
              <option>100</option>
              <option>1000</option>
              <option selected>10000</option>
              <option>100000</option>
            </select>
          </label>
          <button id="hRender" class="btn">Render</button>
          <button id="hExport" class="btn">Export CSV</button>
        </div>
        <div id="heat" style="overflow:auto"></div>
      </div>
      <div class="card">
        <h2>Docs</h2>
        <p><a href="/app/public/explorer.html">API Explorer</a> • <a href="/docs/pricing.md">Pricing doc</a></p>
      </div>
    </div>
    <script>
      const $=id=>document.getElementById(id);
      async function j(url, opts){ const r=await fetch(url,opts||{}); const t=await r.text(); let d=t; try{ d=JSON.parse(t)}catch{} return {ok:r.ok,data:d}; }
      function renderTiers(pol){
        const tiers = pol.tiers||{}; const tenants=pol.tenants||{}; const tbl=[`<table><thead><tr><th>Tier</th><th>Daily quota</th><th>Burst</th></tr></thead><tbody>`];
        Object.entries(tiers).forEach(([k,v])=>{ tbl.push(`<tr><td>${k}</td><td>${v.daily_quota??'-'}</td><td>${v.burst??'-'}</td></tr>`)});
        tbl.push('</tbody></table>');
        const map=[`<h3>Tenants → Tiers</h3><table><thead><tr><th>Tenant</th><th>Tier</th></tr></thead><tbody>`];
        Object.entries(tenants).forEach(([t,tr])=>{ map.push(`<tr><td>${t}</td><td>${tr}</td></tr>`)});
        map.push('</tbody></table>');
        $("tiers").innerHTML = tbl.join('') + map.join('');
      }
      async function calc(){
        const tenant=$("tenant").value||'anonymous';
        const act=$("act").value||'qtm.measure';
        const n=parseInt($("count").value||'0',10)||0;
        const days=parseInt($("days").value||'30',10)||30;
        const r = await j('/v1/billing/estimate',{method:'POST', headers:{'content-type':'application/json','X-Tenant-ID':tenant}, body: JSON.stringify({action:act})});
        if(!r.ok){ $("out").textContent='error'; return; }
        const units=r.data.estimated_units; const monthly = units * n; $("out").textContent = `${act}: ${units} units per request ⇒ ~${monthly} units / month (for ${n} calls, tenant=${tenant}, tier=${r.data.tier})`;
        const rr = await j(`/v1/billing/recommendation?action=${encodeURIComponent(act)}&monthly=${encodeURIComponent(n)}&days=${encodeURIComponent(days)}`);
        if(rr.ok){ const x=rr.data; $("rec").textContent = `Recommendation: ${x.recommended_tier} (current=${x.tier_current}, required_daily_units≈${x.required_daily_units}, upgrade=${x.upgrade_needed})`; }
      }
      function buildHeatmap(pol){
        const tiers = Object.keys(pol.tiers||{});
        const actions = ['qtm.measure','qtm.decoherence','system.analyze','ingest.upload','lexqft.tunnel','proofgate.publish'];
        const costs = {'qtm.measure':1,'qtm.decoherence':1,'system.analyze':3,'ingest.upload':2,'lexqft.tunnel':2,'proofgate.publish':5};
        const vol = parseInt($("hVol").value||'10000',10)||10000;
        const days = parseInt($("hDays").value||'30',10)||30;
        const tbl=[]; tbl.push('<table><thead><tr><th>action \\ tier</th>'+tiers.map(t=>`<th>${t}</th>`).join('')+"</tr></thead><tbody>");
        const csv=[["action",...tiers]];
        actions.forEach(a=>{
          tbl.push(`<tr><td>${a}</td>`);
          const row=[a];
          tiers.forEach(t=>{
            const dq = (pol.tiers[t]||{}).daily_quota||0;
            const req = Math.ceil(costs[a] * (vol/days));
            const ok = dq >= req;
            const margin = dq>0 ? (dq-req)/dq : -1;
            let bg = ok ? '#173e2a' : '#3e171b';
            if(ok && margin < 0.1) bg = '#3a3517';
            tbl.push(`<td style="background:${bg};padding:4px" title="required=${req}/day vs quota=${dq}">${ok?'OK':'NO'}</td>`);
            row.push(ok?"OK":"NO");
          });
          tbl.push('</tr>');
          csv.push(row);
        });
        tbl.push('</tbody></table>');
        $("heat").innerHTML = tbl.join('');
        $("hExport").onclick = ()=>{
          const s = 'data:text/csv;charset=utf-8,'+encodeURIComponent(csv.map(r=>r.join(',')).join('\n'));
          const a=document.createElement('a'); a.href=s; a.download='pricing_heatmap.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };
      }
      async function init(){ const pol = await j('/v1/billing/policies'); if(pol.ok){ renderTiers(pol.data); buildHeatmap(pol.data);} }
      $("calc").addEventListener('click', calc);
      $("hRender").addEventListener('click', async ()=>{ const pol = await j('/v1/billing/policies'); if(pol.ok) buildHeatmap(pol.data); });
      init();
    </script>
    </main>
  </body>
  </html>
